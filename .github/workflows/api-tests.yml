name: API Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 4 * * 1-5'  # –ö–∞–∂–¥—ã–π –±—É–¥–Ω–∏–π –¥–µ–Ω—å –≤ 4:00 UTC (9:00 –ú–°–ö)
  workflow_dispatch:  # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout –∫–æ–¥
      uses: actions/checkout@v3
    
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
      run: |
        python3 << 'EOF'
        import requests
        import sys
        
        username = "${{ secrets.API_USERNAME }}"
        password = "${{ secrets.API_PASSWORD }}"
        
        # Debug: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ–∫—Ä–µ—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã
        if not username or username == "":
            print("‚ùå –û–®–ò–ë–ö–ê: API_USERNAME –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–µ–∫—Ä–µ—Ç–∞—Ö!")
            sys.exit(1)
        if not password or password == "":
            print("‚ùå –û–®–ò–ë–ö–ê: API_PASSWORD –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–µ–∫—Ä–µ—Ç–∞—Ö!")
            sys.exit(1)
        
        print(f"‚úÖ –°–µ–∫—Ä–µ—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã")
        print(f"   Username: {username[:10]}...")  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 10 —Å–∏–º–≤–æ–ª–æ–≤
        
        url = "http://91.227.17.139/services/passport/api/login"
        headers = {
            "Accept": "application/json",
            "Content-Type": "application/json",
            "service": "eputs"
        }
        payload = {"username": username, "password": password}
        
        try:
            response = requests.post(url, json=payload, headers=headers, verify=False, timeout=30)
            print(f"üì° –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: {response.status_code}")
            
            if response.status_code == 200:
                data = response.json()
                print(f"üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞: {list(data.keys())}")
                
                # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
                token = data.get("token") or data.get("access_token") or data.get("data", {}).get("token")
                
                if token:
                    with open('.env', 'w') as f:
                        f.write(f'EPUTS_TOKEN={token}\n')
                    print("‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω")
                else:
                    print("‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ")
                    print(f"   –û—Ç–≤–µ—Ç API: {data}")
                    sys.exit(1)
            else:
                print(f"‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {response.status_code}")
                sys.exit(1)
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
            sys.exit(1)
        EOF
    
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
      run: |
        pytest tests/test_api_info.py::TestTokenCheck::test_incidents_token_check -v
    
    - name: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ Incidents
      run: |
        pytest tests/tests_incidents/ -v --tb=short
      continue-on-error: true
    
    - name: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ DTP
      run: |
        pytest tests/tests_dtp/ -v --tb=short
      continue-on-error: true
    
    - name: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ Metro
      run: |
        pytest tests/tests_metro/ -v --tb=short
      continue-on-error: true
    
    - name: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ Parking
      run: |
        pytest tests/tests_parking/ -v --tb=short
      continue-on-error: true
    
    - name: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ Digital Twin
      run: |
        pytest tests/tests_digital_twin/ -v --tb=short
      continue-on-error: true
    
    - name: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ External Transport
      run: |
        pytest tests/tests_external_transport/ -v --tb=short
      continue-on-error: true
    
    - name: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Allure –æ—Ç—á–µ—Ç–∞
      if: always()
      run: |
        pytest tests/ --alluredir=allure-results -v
      continue-on-error: true
    
    - name: –ü—É–±–ª–∏–∫–∞—Ü–∏—è Allure –æ—Ç—á–µ—Ç–∞
      if: always()
      uses: simple-elf/allure-report-action@master
      with:
        allure_results: allure-results
        allure_history: allure-history
        keep_reports: 20
    
    - name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
      if: success()
      run: echo "‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"
    
    - name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
      if: failure()
      run: echo "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏."

